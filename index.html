<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CSV Editor</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    td[contenteditable="true"] {
      background-color: #f9f9f9;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
    }

        img.thumb {
      max-width: 60px;
      max-height: 60px;
      display: block;
      margin: 0 auto;
    }

    input.img-upload {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>Editable CSV Table</h2>
  <table id="csvTable" class="display" style="width:100%"></table>
  <button id="saveBtn">üíæ Save</button>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    let table;
    let headers = [];

    function parseCSV(text) {
      return text.trim().split("\n").map(row => row.split(","));
    }

    function arrayToCSV(data) {
      return data.map(row =>
        row.map(cell => {
          cell = cell.trim();
          const needsQuotes = /[",\n]/.test(cell);
          const escaped = cell.replace(/"/g, '""');
          return needsQuotes ? `"${escaped}"` : escaped;
        }).join(",")
      ).join("\n");
    }

    fetch("data.csv")
      .then(res => res.text())
      .then(csv => {
        const rows = parseCSV(csv);
        headers = rows[0];
        const data = rows.slice(1);

        table = $('#csvTable').DataTable({
          data: data,
          columns: headers.map(h => ({ title: h })),
          createdRow: function (row) {
            $('td', row).attr('contenteditable', 'true');
            $('td', row).each(function (colIndex, rowIndex) {
            const colName = headers[colIndex];
            const value = data[colIndex] || "";

            if (colName === "Image") {
              const input = document.createElement('input');
              input.type = 'file';
              input.className = 'img-upload';
              input.accept = 'image/*';

              const img = document.createElement('img');
              img.className = 'thumb';
              img.style.display = 'none';
       
              const p = document.createElement('p');
              p.innerHTML = ''

              input.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                  // const url = URL.createObjectURL(file);
                  const url = "http://localhost:8000/images/" + file.name
                  img.src = url;
                  // img.src = 'image/eagle.png'
                  img.style.display = 'block';
                  // console.log(file.name)
                  // this.parentElement.innerHTML = ''   
                  // this.parentElement.appendChild(input);
                  // this.parentElement.appendChild(img); 
                  // this.parentElement.append(file.name)
                  p.innerHTML = file.name             
                }
              });

              // console.log(img.srhelpc)
              // this.innerHTML = '';
              this.appendChild(input);
              this.appendChild(img);
              this.appendChild(p);
            }
            // } else {
            //   $(this).html(`<input type="text" value="${value}">`);
            // }
          });
           },
        columnDefs: [{
          targets: '_all',
          defaultContent: ''
        },
          {
            // The `data` parameter refers to the data for the cell (defined by the
            // `data` option, which defaults to the column being worked with, in
            // this case `data: 0`.
            // render: (data, type, row) => '<img width="200px" src="http://localhost:8000/images/' + data  + '">' + ' (' + row[3] + ')',
            render: (data, type, row) => '<img width="200px" src="http://localhost:8000/images/' + data  + '">',
            targets: 0
        },
           {
            render: (data, type, row) =>  Intl.NumberFormat('en', { maximumSignificantDigits: 15 }).format(data),
            targets: 0
        },
      ]
        });
      });

    document.getElementById("saveBtn").addEventListener("click", () => {
      const updatedData = [];
      const dtData = table.rows().nodes(); // all rows as DOM elements

      dtData.each(function(row) {
        const rowData = [];
        $(row).find("td").each(function () {
          rowData.push($(this).text().trim());
        });
        if (rowData.length > 0) updatedData.push(rowData);
      });

      const csvContent = arrayToCSV([headers, ...updatedData]);

      fetch("/save", {
        method: "POST",
        headers: {
          "Content-Type": "text/plain"
        },
        body: csvContent
      })
      .then(res => {
        if (res.ok) {
          alert("‚úÖ CSV saved successfully!");
        } else {
          alert("‚ùå Error saving CSV.");
        }
      });
    });
  </script>
</body>
</html>

